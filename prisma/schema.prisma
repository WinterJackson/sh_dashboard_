// Prisma schema file,

generator client {
  provider        = "prisma-client-js"
  previewFeatures = ["driverAdapters"]
}

datasource db {
  provider  = "postgresql"
  url       = env("POSTGRES_PRISMA_URL")
  directUrl = env("POSTGRES_URL_NON_POOLING")
}

model User {
  userId     String    @id @default(uuid())
  username   String    @unique
  email      String    @unique
  password   String
  roleId     Int
  hospitalId Int
  isActive   Boolean   @default(true)
  lastLogin  DateTime?

  sessions Session[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  role     Role     @relation(fields: [roleId], references: [roleId])
  hospital Hospital @relation(fields: [hospitalId], references: [hospitalId])
  profile  Profile?
  doctor   Doctor?
}

model Role {
  roleId      Int    @id @default(autoincrement())
  roleName    String @unique
  description String

  users User[]
}

model Profile {
  profileId        String    @id @default(uuid())
  userId           String    @unique
  firstName        String
  lastName         String
  gender           String?
  phone            String?
  address          String?
  dateOfBirth      DateTime?
  imageUrl         String?
  nextOfKin        String?
  nextOfKinPhoneNo String?
  emergencyContact String?

  user User @relation(fields: [userId], references: [userId])
}

model Doctor {
  doctorId           Int              @id @default(autoincrement())
  userId             String           @unique
  email              String           @unique
  hospitalId         Int              @unique
  departmentId       Int
  serviceId          Int
  name               String
  specialization     String
  status             String
  contactInformation String
  workingHours       String
  averageRating      Float
  appointments       Appointment[]
  referrals          DoctorReferral[]
  docEarnings        DoctorEarning[]

  user       User       @relation(fields: [userId], references: [userId])
  hospital   Hospital   @relation(fields: [hospitalId], references: [hospitalId])
  department Department @relation(fields: [departmentId], references: [departmentId]) // New relation to Department model
  service    Service?   @relation(fields: [serviceId], references: [serviceId])
}

model Patient {
  patientId         Int       @id @default(autoincrement())
  hospitalId        Int
  name              String
  phoneNo           String    @unique
  email             String    @unique
  age               Int
  gender            String
  appointmentReason String
  admissionDate     DateTime?
  dischargeDate     DateTime?
  status            String // e.g., Inpatient, Outpatient

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  appointments        Appointment[]
  serviceUsages       ServiceUsage[]
  payments            Payment[]
  referrals           Referral[]
  appointmentServices AppointmentService[]

  hospital   Hospital @relation(fields: [hospitalId], references: [hospitalId])
  currentBed Bed?
}

model Appointment {
  appointmentId   String   @id @default(uuid())
  doctorId        Int
  patientId       Int
  hospitalId      Int
  appointmentDate DateTime
  type            String // (Virtual, Walk-in)
  action          String? // (Reschedule, Cancel)

  status          String? // (Pending, Confirmed, Completed, Cancelled, Rescheduled)
  consultationFee Float?
  isPaid          Boolean

  paymentId            String?
  completed            Boolean
  isVideoStarted       Boolean
  commissionPercentage Float?
  appointmentEndedAt   DateTime?
  
  rescheduledDate      DateTime?
  cancellationReason   String?

  appointmentReminderSent    Int?
  appointmentReminderSentLTF DateTime?

  doctorAppointmentNotes  String?
  patientAppointmentNotes String?
  reasonForVisit          String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  services AppointmentService[]
  payments Payment[]

  patient  Patient  @relation(fields: [patientId], references: [patientId])
  doctor   Doctor   @relation(fields: [doctorId], references: [doctorId])
  hospital Hospital @relation(fields: [hospitalId], references: [hospitalId])
}


model DoctorEarning {
  earningsId  String   @id @default(uuid())
  doctorId    Int      @unique
  date        DateTime
  amount      Float
  description String

  doctor Doctor @relation(fields: [doctorId], references: [doctorId])
}

model Bed {
  bedId        Int    @id @default(autoincrement())
  hospitalId   Int    @unique
  patientId    Int?   @unique
  type         String // e.g., ICU, General
  ward         String
  availability String // e.g., Occupied, Available

  hospital Hospital @relation(fields: [hospitalId], references: [hospitalId])
  patient  Patient? @relation(fields: [patientId], references: [patientId])
}

model Service {
  serviceId     Int                  @id @default(autoincrement())
  hospitalId    Int
  serviceName   String
  doctors       Doctor[]
  appointments  AppointmentService[]
  serviceUsages ServiceUsage[]
  payments      Payment[]
  departments   DepartmentService[]

  hospital Hospital @relation(fields: [hospitalId], references: [hospitalId])
}

model Department {
  departmentId Int                  @id @default(autoincrement())
  name         String               @unique
  description  String
  services     DepartmentService[]
  hospitals    HospitalDepartment[]
  doctors      Doctor[]
}

model DepartmentService {
  departmentId Int
  serviceId    Int
  price        Float

  department Department @relation(fields: [departmentId], references: [departmentId])
  service    Service    @relation(fields: [serviceId], references: [serviceId])

  @@id([departmentId, serviceId])
}

model Payment {
  paymentId     String @id @default(uuid())
  patientId     Int    @unique
  serviceId     Int    @unique
  hospitalId    Int    @unique
  appointmentId String @unique
  amount        Float

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  hospital    Hospital    @relation(fields: [hospitalId], references: [hospitalId])
  service     Service     @relation(fields: [serviceId], references: [serviceId])
  patient     Patient     @relation(fields: [patientId], references: [patientId])
  appointment Appointment @relation(fields: [appointmentId], references: [appointmentId])
}

model AppointmentService {
  appointmentId String
  serviceId     Int
  patientId     Int

  appointment Appointment @relation(fields: [appointmentId], references: [appointmentId])
  service     Service     @relation(fields: [serviceId], references: [serviceId])
  patient     Patient     @relation(fields: [patientId], references: [patientId])

  @@id([appointmentId, serviceId])
}

model ServiceUsage {
  usageId   String   @id @default(uuid())
  serviceId Int      @unique
  patientId Int      @unique
  date      DateTime

  service Service @relation(fields: [serviceId], references: [serviceId])
  patient Patient @relation(fields: [patientId], references: [patientId])
}

model Referral {
  referralId Int              @id @default(autoincrement())
  patientId  Int              @unique
  hospitalId Int
  date       DateTime
  type       String // e.g., Internal, External
  doctors    DoctorReferral[]

  hospital Hospital @relation(fields: [hospitalId], references: [hospitalId])
  patient  Patient  @relation(fields: [patientId], references: [patientId])
}

model DoctorReferral {
  doctorId   Int @unique
  referralId Int @unique
  patientId  Int @unique

  doctor   Doctor   @relation(fields: [doctorId], references: [doctorId])
  referral Referral @relation(fields: [referralId], references: [referralId])

  @@id([doctorId, referralId, patientId])
}

model Hospital {
  hospitalId   Int     @id @default(autoincrement())
  name         String
  phone        String  @unique
  email        String  @unique // Validate email format
  country      String
  city         String
  referralCode String?
  website      String?
  logoUrl      String

  users        User[]
  doctors      Doctor[]
  patients     Patient[]
  appointments Appointment[]
  beds         Bed[]
  services     Service[]
  payments     Payment[]
  departments  HospitalDepartment[]
  referrals    Referral[]
}

model HospitalDepartment {
  hospitalId   Int
  departmentId Int

  hospital   Hospital   @relation(fields: [hospitalId], references: [hospitalId])
  department Department @relation(fields: [departmentId], references: [departmentId])

  @@id([hospitalId, departmentId])
}

model Session {
  sessionId    String   @id @default(uuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime

  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  user         User     @relation(fields: [userId], references: [userId], onDelete: Cascade)
}

model VerificationToken {
  tokenId    Int      @id @default(autoincrement())
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}
